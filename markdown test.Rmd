---
title: "病历本"
author: "Yiyi"
date: "2021/7/30"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style

---
# 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
 rm(list = ls())
```
## Packages
```{r Library, include=FALSE}
library(readxl)
library(data.table)
library(lubridate)#extract cpi time to newdata(furniture48)
library(dplyr) 
library(tidyverse) 
library(broom)
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
Sys.setlocale("LC_TIME","English")

cpi <- read_excel("cpi data/cpi+division+group.xlsx")


setDF(cpi)#convert to 'data.frame'

#
cols.num <- c(colnames(cpi))
cpi[cols.num] <- sapply(cpi[cols.num],as.numeric)
#sapply(cpi,class)

cpi <- as.data.table(cpi)
colnames(cpi) = gsub("&", "and", colnames(cpi))
#class(cpi$`REPAIR OF HOUSEHOLD APPLIANCES1`)
COPY<-copy(cpi)
tracemem(COPY)==tracemem(cpi)


Data_A = as.data.table (cpi)
#



#
Varnames <- copy(names(Data_A))
Data_A[, (names(Data_A)) := lapply(.SD, as.numeric)][,
                                                     rn := .I]
melted <- melt(Data_A, id.vars="rn")[,
                                     (paste0("lag_", 0:12)) := shift(value, 0:12, type="lag"),
                                     by=variable][, 
                                                  value:=NULL][]
res <- dcast.data.table(melt(melted, id.vars=c("rn", "variable"), variable.name="lag"),
                        rn ~ variable + lag, sum)

#view results
res[, ncol(res), with=FALSE]
# lagged variable generation ----------------------------------------------


cpi <- cpi[, unlist(lapply(.SD, shift, n = 0:12), recursive = FALSE)]#lags generation


# Monthly Dummies ---------------------------------------------------------


cpi$time <- seq.Date(from = as.Date("1988/01/01",format = "%Y/%m/%d"), by = "month", length.out = 387)
cpi$time <- format(cpi$time, format = "%b")
Sys.setlocale("LC_TIME","English")
cpi <- fastDummies::dummy_cols(cpi, select_columns = "time", remove_most_frequent_dummy = TRUE,
)
cpi$time1 <- seq.Date(from = as.Date("1988/01/01",format = "%Y/%m/%d"), by = "month", length.out = 387)
#



# Extract time from 1993-2019 ---------------------------------------------



newdata <- with(cpi, cpi[(time1) >= "1993-01-01" & (time1) <= "2019-12-01", ])#start from 93.1
Trend <- seq_along(newdata$time1)
#sapply(newdata, class)



# deal with copy ----------------------------------------------------------


COPY$time1 <- seq.Date(from = as.Date("1988/01/01",format = "%Y/%m/%d"), by = "month", length.out = 387)
COPY <- with(COPY, COPY[(time1) >= "1993-01-01" & (time1) <= "2019-12-01", ])
COPY = subset(COPY, select = -c(time1) )
#lag
```

lag 是2:13 代表1:12. newdata里的1代表的是原数据.
首先把2:13 存储起来, 用paste0(2:13,加上"$")用来匹配以2:13数字结尾的列? 

```{r eval=FALSE, echo=TRUE}
select(x,starts_with("s")) or select(df,end_with("string")) 句法 等同于df%>%select(matches("$"))
```

这两种做法都和之前是完全相等. 都只针对**列**操作,对表格内容无关. 在此只保留
```{r eval=FALSE, echo=TRUE}
select(df,end_with("s"))
```

后续可以查看git 完全匹配字段的两种算法 commit

## Lag and VAT
```{r}
old13<-c(2:13)
for (i in 1:12) {

  assign(paste0("lag",i),select(newdata,ends_with(paste0(old13[i]))))

}
lag1 <- lag1 %>% select(-contains("12"))
lag2 <- lag2 %>% select(-contains("13"))
VAT1 <- as.numeric(newdata$`time1` == "2008-12-01")
VAT2 <- as.numeric(newdata$`time1` == "2010-01-01")
VAT3 <- as.numeric(newdata$`time1` == "2011-01-01")
Recession <- as.numeric(newdata$`time1` >= "2008-04-01" & newdata$`time1`<= "2009-06-01")
```
## Monthly dummies variable position

```{r  MONTYHLY DUMMIES }
monthname<-c("time_Apr","time_Aug", "time_Dec",  "time_Jan","time_Jul","time_Jun" ,"time_Mar","time_May","time_Nov","time_Oct","time_Sep")

for (i in 1:length(monthname)) {
  print(
 which(colnames(newdata)==monthname[i])
)
}
```

## Create time_Apr etc.
the correct version. 首先把月度虚拟变量存储到cpilag 里. 然后用同一迭代变量 送到各自的time_下.
**注意, 双迭代变量还未完全掌握, i 和j 一起用 必出错**
```{r   }
monthdummies<-newdata[,2251:2261]

  for (i in 1:11) {
  assign(colnames(monthdummies)[i],as.numeric(unlist(monthdummies[[i]])))
  }


```
## CPI LDV variables position

```{r simply lag and cpi}

lag.list <- mget(paste0("lag", 1:12))


for (i in 1:12) {
  assign(paste0("lag",i),as.data.frame(lag.list[[i]]))
}

COPY <- as.data.frame(COPY)



# CPI-LAGS ----------------------------------------------------------------
cpi.list<-c(paste0("CPI ALL ITEMS",2:13))

for (i in 1:length(cpi.list)) {
  print(which(colnames(newdata)==cpi.list[i]))
  
}   
cpilag<-newdata[,2:13]
for (i in 1:12) {

    
 
  assign(paste0("CPI_lag",i),as.numeric(unlist(cpilag[,..i])))
  
}


```

## Rgression

```{r model}
# Regression Equation -----------------------------------------------------


reg.model <- lapply(1:173, function(x) lm(COPY[,x] ~ lag1[,x]+lag2[,x]+lag3[,x]+lag4[,x]+
                                            lag5[,x]+lag6[,x]+lag7[,x]+lag8[,x]+lag9[,x]+
                                            lag10[,x]+lag11[,x]+lag12[,x]+ time_Aug + 
                                            time_Dec+ time_Apr+ time_Jan+time_Jul+time_Jun +
                                            time_Mar+time_May+time_Nov+time_Oct+time_Sep+VAT1+VAT2+VAT3+Recession+Trend)
)

for (i in 1:173) {
  names(reg.model[[i]]$coefficients)<-c('Constant','lag1','lag2',"lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12",
                                        "time_Aug" , 
                                        "time_Dec", "time_Feb", "time_Jan","time_Jul","time_Jun" ,"time_Mar",
                                        "time_May","time_Nov","time_Oct","time_Sep","VAT1","VAT2","VAT3","Recession","Trend")
}

regression <- lapply(1:122, function(x) lm(COPY[,x] ~ lag1[,x]+lag2[,x]+lag3[,x]+lag4[,x]+lag5[,x]+lag6[,x]+lag7[,x]+
                                             lag8[,x]+lag9[,x]+lag10[,x]+lag11[,x]+lag12[,x]+CPI_lag1+CPI_lag2+CPI_lag3+CPI_lag4+CPI_lag5+CPI_lag6+CPI_lag7+
                                             CPI_lag8+CPI_lag9+
                                             CPI_lag10+CPI_lag11+CPI_lag12+ time_Aug + 
                                             time_Dec+ time_Apr+ time_Jan+time_Jul+time_Jun +time_Mar+
                                             time_May+time_Nov+time_Oct+time_Sep+VAT1+VAT2+VAT3+Recession+Trend)
)
for (i in 1:122) {
  names(regression[[i]]$coefficients)<-c('Constant','lag1','lag2',"lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12",
                                         "CPI_lag1","CPI_lag2","CPI_lag3","CPI_lag4","CPI_lag5","CPI_lag6","CPI_lag7","CPI_lag8","CPI_lag9",
                                         "CPI_lag10","CPI_lag11","CPI_lag12","time_Aug" , 
                                         "time_Dec", "time_Feb", "time_Jan","time_Jul","time_Jun" ,"time_Mar",
                                         "time_May","time_Nov","time_Oct","time_Sep","VAT1","VAT2","VAT3","Recession","Trend")
}

```
##显著百分比 
```{r}


percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
percent(1)
```
##	Table 1 Summary table before stepwise 前两列
<center>
|![论文第一表](F:/R workspace/Modelling-UK-inflation-quarterly-/table1.jpg)|
|:--:|
| <b>论文第一表</b>|

<center>




```{r}
a=list()
for (i in 1:12) {
  a[[i]] <- lapply(regression[2:122], function(x) summary(x)$coefficients[paste0("CPI_lag",i), 4])
  print(percent(length(which(a[[i]] < 0.05))/121))
  #print(a[[i]])
}
for (i in 1:12) {
  a[[i]] <- lapply(regression[2:122], function(x) summary(x)$coefficients[paste0("CPI_lag",i), 4])
  
  print(percent(length(which(a[[i]] < 0.01))/121))
}

for (i in 1:12) {
  a[[i]] <- lapply(regression[2:122], function(x) summary(x)$coefficients[paste0("lag",i), 4])
  print(percent(length(which(a[[i]] < 0.05))/121))
  #print(a[[i]])
}
for (i in 1:12) {
  a[[i]] <- lapply(regression[2:122], function(x) summary(x)$coefficients[paste0("lag",i), 4])
  
  print(percent(length(which(a[[i]] < 0.01))/121))
}
```
## 后两列(Weight)
例如,01部门属于2-15.

```{r}
# Weight ------------------------------------------------------------------
weight<- list(0.109,	0.042,	0.063,	0.115,	0.067,	0.022,	0.152,	0.023,	0.152,	0.019,	0.137,	0.099
              
)
Reduce("+",weight)
```
用lapply 把regression 这个list 化成长数据框类型.(多行,5列:term,estimate,std,statitc, pvalue)
```{r}

tidy_mods <- lapply(regression, tidy)

for (i in 1:length(tidy_mods)) tidy_mods[[i]]$mod <- names(tidy_mods[i])
a <- do.call(rbind.data.frame, tidy_mods)
str(a)
```
数数a里面有多少个vat1,就有多少个数据.which(a$term=="Trend")[1]代表第一个trend在哪个位置.
每个部门的参数开始于constant,结束于Trend.



42:615行之间lag[n]且p<0.05的*weight[1]的length

* * *
01 Food and non-alcoholic beverages
**2-15**
02 Alcoholic beverages, tobacco and narcotics
**16-21**
03 Clothing and footwear
**22-27**
04 Housing, water, electricity, gas and other fuels
**28:40 **
05 Furnishings, household equipment and routine household maintenance
**41:53 **
06 Health
**54:61 **
07 Transport
**62:76 **
08 Communication
**77:79 **
09 Recreation and culture
**[80:101**
10 Education
**102**
11 Restaurants and hotels
**103：107**
12 Miscellaneous goods and services
**108：122**

* * *




```{r}
dend<-c(2,16,22,28,41,54,62,77,80,102,103,108,122)#这只是每个部门开始的位置
for (i in 1:12) {
  assign(paste0("a",i),
         a[(which(a$term=="Constant")[dend[i]]):(which(a$term=="Trend")[dend[i+1]-1]),])
}
```
第一个constant的位置,到下一个Trend-1的位置.
第一个部门是2:15, 开始的标志是第二个constant的位置(dend[1]),结束于第15个Trend的位置(dend[2]-1的trend).
**之所以不是直接开始于constant[dend[1]],结束于trend[dend[1]],是因为dend只是开始位置的集合(constant)而并不是结束的位置(trend).**

*如果constant[dend[1]]---trend[dend[1]],这代表第二个(dend[1]=2) constant的开始到第二个trend的结束.只是一个class.*

**如果constant[dend[1]]---trend[dend[2]],这代表第二个constant的开始到第16(dend[2]=16) 个trend的结束.我需要的是到第15个结束**

```{r eval=FALSE, include=FALSE}
a11111<-a[42:615,]
identical(a11111,a1)
length(which(a11111$term=="lag1"&a1$p.value<0.01))
```

```{r}
for (i in 1:12) {
  print(length(a[i]))
}
noquote(paste0(
  "a",1
))
```

```{r eval=FALSE, include=FALSE}
for (i in 1:12) {
  print(length(
    which(a1$term==paste0("lag",i) &a1$p.value<0.01)
  )*weight[[1]]
  )

}
```
```{r}




# One way to recover from that mistake is to grab them all up with ls/mget
for (i in 1:12) {
  alist<-a[i]
  
}
alist<-cbli
dat_list <- mget(x = ls(pattern = "dat_[0-9]*_[0-9]*"))

```

