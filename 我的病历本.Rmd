---
title: "病历本"
author: "Yiyi"
date: "`r Sys.Date()`"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: yes
    toc_depth: '3'
---
# 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
 rm(list = ls())
Sys.setlocale("LC_TIME", "English")
```
## Packages
```{r Library, include=FALSE}
library(readxl)
library(data.table)
library(lubridate)#extract cpi time to newdata(furniture48)
library(dplyr) 
library(tidyverse) 
library(broom)
library(stargazer)
library(knitr)
library(officer)
library(flextable)
library(magrittr)
library(dplyr)
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
Sys.setlocale("LC_TIME","English")

cpi <- read_excel("cpi data/cpi+division+group.xlsx")


setDF(cpi)#convert to 'data.frame'

#
cols.num <- c(colnames(cpi))
cpi[cols.num] <- sapply(cpi[cols.num],as.numeric)
#sapply(cpi,class)

cpi <- as.data.table(cpi)
colnames(cpi) = gsub("&", "and", colnames(cpi))
#class(cpi$`REPAIR OF HOUSEHOLD APPLIANCES1`)
COPY<-copy(cpi)
tracemem(COPY)==tracemem(cpi)


Data_A = as.data.table (cpi)
#



#
Varnames <- copy(names(Data_A))
Data_A[, (names(Data_A)) := lapply(.SD, as.numeric)][,
                                                     rn := .I]
melted <- melt(Data_A, id.vars="rn")[,
                                     (paste0("lag_", 0:12)) := shift(value, 0:12, type="lag"),
                                     by=variable][, 
                                                  value:=NULL][]
res <- dcast.data.table(melt(melted, id.vars=c("rn", "variable"), variable.name="lag"),
                        rn ~ variable + lag, sum)

#view results
res[, ncol(res), with=FALSE]
# lagged variable generation ----------------------------------------------


cpi <- cpi[, unlist(lapply(.SD, shift, n = 0:12), recursive = FALSE)]#lags generation


# Monthly Dummies ---------------------------------------------------------


cpi$time <- seq.Date(from = as.Date("1988/01/01",format = "%Y/%m/%d"), by = "month", length.out = 387)
cpi$time <- format(cpi$time, format = "%b")
Sys.setlocale("LC_TIME","English")
cpi <- fastDummies::dummy_cols(cpi, select_columns = "time", remove_most_frequent_dummy = TRUE,
)
cpi$time1 <- seq.Date(from = as.Date("1988/01/01",format = "%Y/%m/%d"), by = "month", length.out = 387)
#



# Extract time from 1993-2019 ---------------------------------------------



newdata <- with(cpi, cpi[(time1) >= "1993-01-01" & (time1) <= "2019-12-01", ])#start from 93.1
Trend <- seq_along(newdata$time1)
#sapply(newdata, class)



# deal with copy ----------------------------------------------------------


COPY$time1 <- seq.Date(from = as.Date("1988/01/01",format = "%Y/%m/%d"), by = "month", length.out = 387)
COPY <- with(COPY, COPY[(time1) >= "1993-01-01" & (time1) <= "2019-12-01", ])
COPY = subset(COPY, select = -c(time1) )
#lag
```

lag 是2:13 代表1:12. newdata里的1代表的是原数据.
首先把2:13 存储起来, 用paste0(2:13,加上"$")用来匹配以2:13数字结尾的列? 

```{r eval=FALSE, echo=TRUE}
select(x,starts_with("s")) or select(df,end_with("string")) 句法 等同于df%>%select(matches("$"))
```

这两种做法都和之前是完全相等. 都只针对**列**操作,对表格内容无关. 在此只保留
```{r eval=FALSE, echo=TRUE}
select(df,end_with("s"))
```

后续可以查看git 完全匹配字段的两种算法 commit

## Lag and VAT
```{r}
old13<-c(2:13)
for (i in 1:12) {

  assign(paste0("lag",i),select(newdata,ends_with(paste0(old13[i]))))

}
lag1 <- lag1 %>% select(-contains("12"))
lag2 <- lag2 %>% select(-contains("13"))
VAT1 <- as.numeric(newdata$`time1` == "2008-12-01")
VAT2 <- as.numeric(newdata$`time1` == "2010-01-01")
VAT3 <- as.numeric(newdata$`time1` == "2011-01-01")
Recession <- as.numeric(newdata$`time1` >= "2008-04-01" & newdata$`time1`<= "2009-06-01")
```
## Monthly dummies variable position

```{r  MONTYHLY DUMMIES }
monthname<-c("time_Apr","time_Aug", "time_Dec",  "time_Jan","time_Jul","time_Jun" ,"time_Mar","time_May","time_Nov","time_Oct","time_Sep")

for (i in 1:length(monthname)) {
  print(
 which(colnames(newdata)==monthname[i])
)
}
```

## Create time_Apr etc.
the correct version. 首先把月度虚拟变量存储到cpilag 里. 然后用同一迭代变量 送到各自的time_下.
**注意, 双迭代变量还未完全掌握, i 和j 一起用 必出错**
```{r   }
monthdummies<-newdata[,2251:2261]

  for (i in 1:11) {
  assign(colnames(monthdummies)[i],as.numeric(unlist(monthdummies[[i]])))
  }


```
## CPI LDV variables position

```{r simply lag and cpi}

lag.list <- mget(paste0("lag", 1:12))


for (i in 1:12) {
  assign(paste0("lag",i),as.data.frame(lag.list[[i]]))
}

COPY <- as.data.frame(COPY)



# CPI-LAGS ----------------------------------------------------------------
cpi.list<-c(paste0("CPI ALL ITEMS",2:13))

for (i in 1:length(cpi.list)) {
  print(which(colnames(newdata)==cpi.list[i]))
  
}   
cpilag<-newdata[,2:13]
for (i in 1:12) {

    
 
  assign(paste0("CPI_lag",i),as.numeric(unlist(cpilag[,..i])))
  
}


```

## Rgression

```{r model}
# Regression Equation -----------------------------------------------------


reg.model <- lapply(1:173, function(x) lm(COPY[,x] ~ lag1[,x]+lag2[,x]+lag3[,x]+lag4[,x]+
                                            lag5[,x]+lag6[,x]+lag7[,x]+lag8[,x]+lag9[,x]+
                                            lag10[,x]+lag11[,x]+lag12[,x]+ time_Aug + 
                                            time_Dec+ time_Apr+ time_Jan+time_Jul+time_Jun +
                                            time_Mar+time_May+time_Nov+time_Oct+time_Sep+VAT1+VAT2+VAT3+Recession+Trend)
)

for (i in 1:173) {
  names(reg.model[[i]]$coefficients)<-c('Constant','lag1','lag2',"lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12",
                                        "time_Aug" , 
                                        "time_Dec", "time_Feb", "time_Jan","time_Jul","time_Jun" ,"time_Mar",
                                        "time_May","time_Nov","time_Oct","time_Sep","VAT1","VAT2","VAT3","Recession","Trend")
}

regression <- lapply(1:122, function(x) lm(COPY[,x] ~ lag1[,x]+lag2[,x]+lag3[,x]+lag4[,x]+lag5[,x]+lag6[,x]+lag7[,x]+
                                             lag8[,x]+lag9[,x]+lag10[,x]+lag11[,x]+lag12[,x]+CPI_lag1+CPI_lag2+CPI_lag3+CPI_lag4+CPI_lag5+CPI_lag6+CPI_lag7+
                                             CPI_lag8+CPI_lag9+
                                             CPI_lag10+CPI_lag11+CPI_lag12+ time_Aug + 
                                             time_Dec+ time_Apr+ time_Jan+time_Jul+time_Jun +time_Mar+
                                             time_May+time_Nov+time_Oct+time_Sep+VAT1+VAT2+VAT3+Recession+Trend)
)
for (i in 1:122) {
  names(regression[[i]]$coefficients)<-c('Constant','lag1','lag2',"lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12",
                                         "CPI_lag1","CPI_lag2","CPI_lag3","CPI_lag4","CPI_lag5","CPI_lag6","CPI_lag7","CPI_lag8","CPI_lag9",
                                         "CPI_lag10","CPI_lag11","CPI_lag12","time_Aug" , 
                                         "time_Dec", "time_Feb", "time_Jan","time_Jul","time_Jun" ,"time_Mar",
                                         "time_May","time_Nov","time_Oct","time_Sep","VAT1","VAT2","VAT3","Recession","Trend")
}

```


##前两列显著百分比 
```{r}


percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
percent(1)

```
##	Table 1 Summary table before stepwise 前两列
<center>
|![论文第一表](F:/R workspace/Modelling-UK-inflation-quarterly-/table1.jpg)|
|:--:|
| <b>论文第一表</b>|

<center>



## **85部门版本合集生成**
```{r}
sig.class<-c(regression[4:12],regression[14:15],#1,
             regression[18:21],#2
             regression[24:27],#3
             regression[29],regression[31:32],regression[34:35],regression[37:40],#4
             regression[43:45],regression[47:50],regression[52:53],#5
             regression[56:57],regression[59:61],#6
             regression[64:66],regression[68:71],regression[73:76],#7
             regression[78:79],#8
             regression[82:86],regression[88],regression[90:93],regression[95:96],regression[98:100],regression[101],#9
             regression[102],#10
             regression[105:107],#11
             regression[110:111],regression[113:115],regression[117:119],regression[121:122])#12
```
**各部门个数**

```{r}
###1
n1<-length(c(4:12,14:15))
###2
#2
n2<-length(c(18:21))
#3
n3<-length(c(24:27))
#4
n4<-length(c(29,31:32,34:35,37:40))
#5
n5<-length(c(43:45,47:50,52:53))
#6
n6<-length(c(56:57,59:61))
#7
n7<-length(c(64:66,68:71,73:76))
#8
n8<-length(c(78:79))
#9
n9<-length(c(82:86,88,90:93,95:96,98:100,101))
#10
n10<-length(c(102))
#11
n11<-length(c(105:107))
#12
n12<-length(c(110:111,113:115,117:119,121:122))
#85
11+4+4+9+9+5+11+2+16+1+3+10
```

**/121有double counting的嫌疑,就/85把**
```{r}
a=list()
for (i in 1:12) {
  a[[i]] <- lapply(sig.class, function(x) summary(x)$coefficients[paste0("CPI_lag",i), 4])
  print(percent(length(which(a[[i]] < 0.05))/85))
  #print(a[[i]])
}
for (i in 1:12) {
  a[[i]] <- lapply(sig.class, function(x) summary(x)$coefficients[paste0("CPI_lag",i), 4])
  
  print(percent(length(which(a[[i]] < 0.01))/85))
}

for (i in 1:12) {
  a[[i]] <- lapply(sig.class, function(x) summary(x)$coefficients[paste0("lag",i), 4])
  print(percent(length(which(a[[i]] < 0.05))/85))
  #print(a[[i]])
}
for (i in 1:12) {
  a[[i]] <- lapply(sig.class, function(x) summary(x)$coefficients[paste0("lag",i), 4])
  
  print(percent(length(which(a[[i]] < 0.01))/85))
}
```


## 后两列(Weight)
例如,01部门属于2-15.

```{r}
percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
# Weight ------------------------------------------------------------------
weight<- list(0.109,	0.042,	0.063,	0.115,	0.067,	0.022,	0.152,	0.023,	0.152,	0.019,	0.137,	0.099
              
)
Reduce("+",weight)
```






* * *
01 Food and non-alcoholic beverages
**2-15**
02 Alcoholic beverages, tobacco and narcotics
**16-21**
03 Clothing and footwear
**22-27**
04 Housing, water, electricity, gas and other fuels
**28:40 **
05 Furnishings, household equipment and routine household maintenance
**41:53 **
06 Health
**54:61 **
07 Transport
**62:76 **
08 Communication
**77:79 **
09 Recreation and culture
**[80:101**
10 Education
**102**
11 Restaurants and hotels
**103：107**
12 Miscellaneous goods and services
**108：122**

* * *

因为每个部门现在是间断的了,不再连续, 所以之前根据constant转化的办法不行了.
## 手动生成a1:a12.
```{r}
a1<-c(regression[4:12],regression[14:15])
a2<-c(regression[18:21])
a3<-c(regression[24:27])
a4<-c( regression[29],regression[31:32],regression[34:35],regression[37:40])
a5<-c(regression[43:45],regression[47:50],regression[52:53])
a6<-c( regression[56:57],regression[59:61])
a7<-c(regression[64:66],regression[68:71],regression[73:76])
a8<-c(regression[78:79])
a9<-c(regression[82:86],regression[88],regression[90:93],regression[95:96],regression[98:100],regression[101])
a10<-c(regression[102])
a11<-c(regression[105:107])
a12<-c(regression[110:111],regression[113:115],regression[117:119],regression[121:122])
```

用lapply 把regression 这个list 化成长数据框类型.(多行,5列:term,estimate,std,statitc, pvalue)
**再更新85版本之后, 可以用85版本的sig.class 替代 regression,避免了之后的操作**

```{r}

tidy_mods <- lapply(regression, tidy)

for (i in 1:length(tidy_mods)) 
  tidy_mods[[i]]$mod <- names(tidy_mods[i])


```


```{r}
a1<-c(tidy_mods[4:12],tidy_mods[14:15])
a2<-c(tidy_mods[18:21])
a3<-c(tidy_mods[24:27])
a4<-c( tidy_mods[29],tidy_mods[31:32],tidy_mods[34:35],tidy_mods[37:40])
a5<-c(tidy_mods[43:45],tidy_mods[47:50],tidy_mods[52:53])
a6<-c( tidy_mods[56:57],tidy_mods[59:61])
a7<-c(tidy_mods[64:66],tidy_mods[68:71],tidy_mods[73:76])
a8<-c(tidy_mods[78:79])
a9<-c(tidy_mods[82:86],tidy_mods[88],tidy_mods[90:93],tidy_mods[95:96],tidy_mods[98:100],tidy_mods[101])
a10<-c(tidy_mods[102])
a11<-c(tidy_mods[105:107])
a12<-c(tidy_mods[110:111],tidy_mods[113:115],tidy_mods[117:119],tidy_mods[121:122])
```



```{r}
test<-list()
for (i in 1:12) {
test[[i]] <- do.call(rbind.data.frame, get(paste0("a",i)))
}
nrow(test[[1]])
```

**检查test[1:12]是否和a1:a13相等**
```{r}
for (i in 1:12) {print(
  length(which(test[[i]]$term=="Trend"))==
    length(get(paste0("a",i)))
)
  
}


```




$$
\frac{\text{部门}1\text{显著个数}}{\text{部门}1\text{的数量}}*weight\left[ 1 \right] 
$$

### a_lag.0.01

```{r}
# 首先生成一个12*12的dataframe, 行是lag1-12, 列是a1:a12 十二个部门.
a_lag.0.01<-data.frame( row.names =  paste0("lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_lag.0.01)<-c(paste0("a",1:12))
# 双循环,每个部门循环把lag1-lag12 循环一边存储在a_lag_0.01[,i]列里,代表在第一个部门 lag<0.01的
# 然后再循环剩下11个部门.
# **a1中的lag1-12且小于0.01的个数/ 部门1 class的个数乘 weight[1].**
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_lag.0.01 [j,i]  <-  length( which(test[[i]]$term==paste0("lag",j)&test[[i]]$p.value<0.01)
  ) /length(get(paste0("a",i))) *weight[[i]]
  }
  i<-i+1
}
```

a8全都是0. 证实了一下确实. 有在0.05显著的,但是没有在0.01显著的.
```{r a8test, eval=FALSE, include=FALSE}
for (j in 1:12) {print(
  length(which(test[[8]]$term==paste0("lag",j)&test[[8]]$p.value<0.01)))
}

  
stargazer(regression[78:79],
          star.cutoffs = c(0.05, 0.01),
          
          report = "vc*",
          align=TRUE,           
          header = FALSE,
          model.numbers=FALSE,
          column.labels = c(colnames(COPY[2:15])),
          df=FALSE, 
          digits=2, single.row = TRUE,
          summary=FALSE,
          se = NULL, type = "text")
```
### a_lag.0.05
```{r}
a_lag.0.05<-data.frame( row.names =  paste0("lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_lag.0.05)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_lag.0.05 [j,i]  <-
  length( which(
   test[[i]]$term==paste0("lag",j)&test[[i]]$p.value<0.05)
  )/length(get(paste0("a",i))) *weight[[i]]
  }
  i<-i+1
}
```

### a_cpi.0.01

```{r}
a_cpi.0.01<-data.frame( row.names =  paste0("CPI_lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_cpi.0.01)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_cpi.0.01 [j,i]  <-
  length( which(test[[i]]$term==paste0("CPI_lag",j)&test[[i]]$p.value<0.01)
  )/length(get(paste0("a",i))) *weight[[i]]
  }
  i<-i+1
}
```

### a_cpi.0.05
```{r}
a_cpi.0.05<-data.frame( row.names =  paste0("CPI_lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_cpi.0.05)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_cpi.0.05 [j,i]  <-
  length( which(test[[i]]$term==paste0("CPI_lag",j)&test[[i]]$p.value<0.05)
  )/length(get(paste0("a",i))) *weight[[i]]
  }
  i<-i+1
}
```





每行代表:lag 0.01 12个部门里, lag1 小于0.01的/个数*weight的总和
把a_cpi.0.05这四个表, 每行加起来 就是结果.
一行一个结果,每个表有12行,共4个表,**4×12=48**个结果.
首先生成存放结果的 24行×2列的dataframe



# 所有table1的结果都写入,这次要生成24*4的dataframe
```{r}
table1weight<-data.frame( matrix(nrow=24, ncol=4, )   )
colnames(table1weight)<-c("p<0.01","p<0.05","p<0.01(Weight)","p<0.05(Weight)")
rownames(table1weight)<-c(paste0("CPI_lag",1:12),paste0("lag",1:12))
```
写入结果
sig.class 转换成只有4列的长数据类型, 方便使用
```{r}

tidy_mods <- lapply(sig.class, tidy)

for (i in 1:length(tidy_mods)) 
  tidy_mods[[i]]$mod <- names(tidy_mods[i])
sig.class.4cols <- do.call(rbind.data.frame, tidy_mods)
length(which(sig.class.4cols$term=="Trend"))

```


```{r}
for (i in 1:12) {#前两列
  table1weight[i,1]<-percent((length( which(sig.class.4cols$term==paste0("CPI_lag",i)&(sig.class.4cols$p.value<0.01))))/85)
   table1weight[i+12,1]<-percent((length( which(sig.class.4cols$term==paste0("lag",i)&(sig.class.4cols$p.value<0.01))))/85)
   table1weight[i,2]<-percent((length( which(sig.class.4cols$term==paste0("CPI_lag",i)&(sig.class.4cols$p.value<0.05))))/85)
      table1weight[i+12,2]<-percent((length( which(sig.class.4cols$term==paste0("lag",i)&(sig.class.4cols$p.value<0.05))))/85)
      #后两列
    table1weight[i,3]<-percent(sum(a_cpi.0.01[paste0("CPI_lag",i),]))
    table1weight[i+12,3]<-percent(sum(a_lag.0.01[paste0("lag",i),]))
    table1weight[i,4]<-percent(sum(a_cpi.0.05[paste0("CPI_lag",i),]))
    table1weight[i+12,4]<-percent(sum(a_lag.0.05[paste0("lag",i),]))
    
}



```

flextable 写入word
```{r}

ft1<-flextable(table1weight %>% rownames_to_column("column name"))




save_as_docx("Summary table before stepwise" = ft1, path = "F:/R workspace/Modelling-UK-inflation-quarterly-/table1.docx")




```


***************


# Table 2 Stepwise Summary Table

## stepwise function
```{r}
# function ----------------------------------------------------------------


# Automated model selection
# Author      : Joris Meys
# version     : 0.2
# date        : 12/01/09

#CHANGE LOG
# 0.2   : check for empty scopevar vector

# #CHANGE LOG -------------------------------------------------------------



# Function has.interaction checks whether x is part of a term in terms
# terms is a vector with names of terms from a model
has.interaction <- function(x,terms){
  out <- sapply(terms,function(i){
    sum(1-(strsplit(x,":")[[1]] %in% strsplit(i,":")[[1]]))==0
  })
  return(sum(out)>0)
}

# Function Model.select
# model is the lm object of the full model
# keep is a list of model terms to keep in the model at all times
# sig gives the significance for removal of a variable. Can be 0.1 too (see SPSS)
# verbose=T gives the F-tests, dropped var and resulting model after 
model.select <- function(model,keep,sig=0.05,verbose=F){
  counter=1
  # check input
  if(!is(model,"lm")) stop(paste(deparse(substitute(model)),"is not an lm object\n"))
  # calculate scope for drop1 function
  terms <- attr(model$terms,"term.labels")
  if(missing(keep)){ # set scopevars to all terms
    scopevars <- terms
  } else{            # select the scopevars if keep is used
    index <- match(keep,terms)
    # check if all is specified correctly
    if(sum(is.na(index))>0){
      novar <- keep[is.na(index)]
      warning(paste(
        c(novar,"cannot be found in the model",
          "\nThese terms are ignored in the model selection."),
        collapse=" "))
      index <- as.vector(na.omit(index))
    }
    scopevars <- terms[-index]
  }
  
  # Backward model selection : 
  
  while(T){
    # extract the test statistics from drop.
    test <- drop1(model, scope=scopevars,test="F")
    
    if(verbose){
      cat("-------------STEP ",counter,"-------------\n",
          "The drop statistics : \n")
      print(test)
    }
    
    pval <- test[,dim(test)[2]]
    
    names(pval) <- rownames(test)
    pval <- sort(pval,decreasing=T)
    
    if(sum(is.na(pval))>0) stop(paste("Model",
                                      deparse(substitute(model)),"is invalid. Check if all coefficients are estimated."))
    
    # check if all significant
    if(pval[1]<sig) break # stops the loop if all remaining vars are sign.
    
    # select var to drop
    i=1
    while(T){
      dropvar <- names(pval)[i]
      check.terms <- terms[-match(dropvar,terms)]
      x <- has.interaction(dropvar,check.terms)
      if(x){i=i+1;next} else {break}              
    } # end while(T) drop var
    
    if(pval[i]<sig) break # stops the loop if var to remove is significant
    
    if(verbose){
      cat("\n--------\nTerm dropped in step",counter,":",dropvar,"\n--------\n\n")              
    }
    
    #update terms, scopevars and model
    scopevars <- scopevars[-match(dropvar,scopevars)]
    terms <- terms[-match(dropvar,terms)]
    
    formul <- as.formula(paste(".~.-",dropvar))
    model <- update(model,formul)
    
    if(length(scopevars)==0) {
      warning("All variables are thrown out of the model.\n",
              "No model could be specified.")
      return()
    }
    counter=counter+1
  } # end while(T) main loop
  return(model)
}

```

# **如果简化到0.01, 所有变量都在0.01显著了, 那0.05的列就全是0了.** 所以只有个 stepwsie function, 那就是到0.05.
```{r}
slr.total <- list()
keep.dummies <- c("time_Aug","time_Apr",
                  "time_Dec",  "time_Jan","time_Jul","time_Jun" ,"time_Mar","time_May","time_Nov","time_Oct","time_Sep",
                  "VAT1","VAT2","VAT3","Recession","Trend")
for (i in 1:length(sig.class)) {
  slr.total[[i]] <- model.select(sig.class[[i]], keep = keep.dummies, sig = 0.05, verbose = F)
}

```
**slr.total 60 是空集, 84 left**


```{r}
#去除空集
slr.total[sapply(slr.total, is.null)] <- NULL

#替换名称
search_for_these <- c("lag1[, x]","lag2[, x]","lag3[, x]","lag4[, x]","lag5[, x]","lag6[, x]","lag7[, x]","lag8[, x]","lag9[, x]","lag10[, x]","lag11[, x]","lag12[, x]")
 replace_with_these <- c("lag1","lag2","lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12")
 found<-list()
for (i in 1:length(slr.total)) {
  found[[i]] <- match(names(slr.total[[i]]$coefficients), search_for_these, nomatch = 0)
  names(slr.total[[i]]$coefficients)[names(slr.total[[i]]$coefficients) %in% search_for_these] <- replace_with_these[found[[i]]]
}
```


```{r}
#化成长数据类型
 tidy_stepwsie <- lapply(slr.total, tidy)
  stepwsie_a<- do.call(rbind.data.frame, tidy_stepwsie)
```
因为已经删减过cpi and 60, 所以stepwsie_a只剩下120个项目了.
```{r}
length(which(stepwsie_a$term=="VAT1"))
```
## 各部门开始结束位置df
```{r}
class.poi<-data.frame(matrix(nrow = 13,ncol = 2),row.names = 1:13)
names(class.poi)<-c("start","end")
poi<-c(1,11,4,4,9,9,5,11,2,15,1,3,10)
class.poi[,1]<-c(cumsum(poi))#每个部门开始的位置
class.poi[,2]<-c((class.poi[,1]-1)[-1],"na")#结束的位置
class.poi<-head(class.poi,-1)#删除最后一行
write.csv(class.poi,"F:/R workspace/Modelling-UK-inflation-quarterly-/class-poisition.csv")




```
**60属于第9部门**
**根据 intercept 开始的位置, 和trend结束位置 划分df**
```{r}
start<-class.poi[,1]
start[1]
end<-as.numeric(class.poi[,2])
end<-replace(end,end==85,84)#没有85 slr.total最后只剩84个了
for (i in 1:12) {
  assign(paste0("stepwsie_a",i),
         stepwsie_a[
           (which(stepwsie_a$term=="(Intercept)")[start[i]])
           :
             (which(stepwsie_a$term=="Trend")[end[i]])
           ,]
         )
}
length(which(stepwsie_a12$term=="Trend"))
```

## 创建	Table 2 Stepwise Summary Table 存储结果
同样是24*4.
```{r}
stepwise_table_yearly<-data.frame( matrix(nrow=24, ncol=4, )   )
colnames(stepwise_table_yearly)<-c("p<0.01","p<0.05","p<0.01(Weight)","p<0.05(Weight)")
rownames(stepwise_table_yearly)<-c(paste0("CPI_lag",1:12),paste0("lag",1:12))
```

### stepwise_lag_0.01_yearly
```{r}

stepwise_lag_0.01_yearly<-data.frame( row.names =  paste0("lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(stepwise_lag_0.01_yearly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 stepwise_lag_0.01_yearly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.01)
  )/length(which(get(paste0("stepwsie_a",i))$term=="Trend")) *weight[[i]]
  }
  i<-i+1
}
```
### stepwise_lag_0.05_yearly
```{r}

stepwise_lag_0.05_yearly<-data.frame( row.names =  paste0("lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(stepwise_lag_0.05_yearly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 stepwise_lag_0.05_yearly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.05)
  )/length(which(get(paste0("stepwsie_a",i))$term=="Trend"))*weight[[i]]
  }
  i<-i+1
}
```
### stepwise_cpi_0.01_yearly
```{r}
stepwise_cpi_0.01_yearly<-data.frame( row.names =  paste0("CPI_lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(stepwise_cpi_0.01_yearly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 stepwise_cpi_0.01_yearly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("CPI_lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.01)
  )/length(which(get(paste0("stepwsie_a",i))$term=="Trend"))*weight[[i]]
  }
  i<-i+1
}
```
### stepwise_cpi_0.05_yearly
```{r}
stepwise_cpi_0.05_yearly<-data.frame( row.names =  paste0("CPI_lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(stepwise_cpi_0.05_yearly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 stepwise_cpi_0.05_yearly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("CPI_lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.05)
  )/length(which(get(paste0("stepwsie_a",i))$term=="Trend"))*weight[[i]]
  }
  i<-i+1
}
```
# 写入table2
**与之前版本最大区别是后两列不用/85或者/121.**
```{r}
for (i in 1:12) {#前两列
  stepwise_table_yearly[i,1]<-percent((length( which(stepwsie_a$term==paste0("CPI_lag",i)&(stepwsie_a$p.value<0.01))))/85)
   stepwise_table_yearly[i+12,1]<-percent((length( which(stepwsie_a$term==paste0("lag",i)&(stepwsie_a$p.value<0.01))))/85)
   stepwise_table_yearly[i,2]<-percent((length( which(stepwsie_a$term==paste0("CPI_lag",i)&(stepwsie_a$p.value<0.05))))/85)
      stepwise_table_yearly[i+12,2]<-percent((length( which(stepwsie_a$term==paste0("lag",i)&(stepwsie_a$p.value<0.05))))/85)
      #后两列
    stepwise_table_yearly[i,3]<-percent(sum(stepwise_cpi_0.01_yearly[paste0("CPI_lag",i),])      )
    stepwise_table_yearly[i+12,3]<-percent(sum(stepwise_lag_0.01_yearly[paste0("lag",i),]))
    stepwise_table_yearly[i,4]<-percent(sum(stepwise_cpi_0.05_yearly[paste0("CPI_lag",i),]))
    stepwise_table_yearly[i+12,4]<-percent(sum(stepwise_lag_0.05_yearly[paste0("lag",i),]))
    
}
```
## flextable 写入word
```{r}



ft1<-flextable(stepwise_table_yearly %>% rownames_to_column("column name"))




save_as_docx("1.5	Table 2 Stepwise Summary Table" = ft1, path = "F:/R workspace/Modelling-UK-inflation-quarterly-/table2.docx")




```

**很开心, stargazer coeff 排序的方法在此!**
```{r}
length(slr.total[[2]]$coefficients)
vars.order<-c("lag1","lag2","lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12","CPI_lag1","CPI_lag2","CPI_lag3","CPI_lag4","CPI_lag5","CPI_lag6","CPI_lag7",
                                             "CPI_lag8","CPI_lag9",
                                             "CPI_lag10","CPI_lag11","CPI_lag12")
stargazer(slr.total[2:7],
          star.char = c("*"),
          star.cutoffs = c(0.01),
          notes = c(" * p<0.01; "),
          omit = c("time_Aug","time_Dec", "time_Apr", "time_Jan","time_Jul","time_Jun" ,"time_Mar","time_May","time_Nov","time_Oct","time_Sep",
                   "VAT1","VAT2","VAT3","Recession","Trend",'Constant'),
          order=paste0("^", vars.order , "$"),
          dep.var.labels.include = FALSE,
          notes.append = FALSE,

          report = "vc*",
          align = TRUE,
          header = FALSE,
          df = FALSE,
          digits = 2, single.row = TRUE,
          model.numbers = FALSE,
          column.labels = c(colnames(COPY[2:7])),
          summary = FALSE,
          out = "F:/R workspace/Modelling-UK-inflation-quarterly-/Table 2 Stepwise Summary Table/1-1.html",
          flip = FALSE,
          se = NULL,type = "text"
)
```
## CPI itself
```{r}
CPI_ <- reg.model[[1]]
slr.cpi <- model.select(CPI_,keep = keep.dummies,sig = 0.05,verbose = F)


#替换名称




stargazer(CPI_, slr.cpi,
          star.char = c("*"), 
          star.cutoffs = c(0.05, 0.01),
          notes = c(" * p<0.05; ** p<0.01; "),
          omit = c("time_Aug","time_Dec", "time_Feb", "time_Jan","time_Jul","time_Jun" ,"time_Apr",
                   "time_Mar","time_May","time_Nov","time_Oct","time_Sep", "VAT1","VAT2",
                   "VAT3","Recession","Trend",'Constant'), 
          dep.var.labels.include = FALSE, 
          notes.append = FALSE, 
          order = c("lag1","lag2","lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12","CPI_lag1","CPI_lag2","CPI_lag3","CPI_lag4","CPI_lag5","CPI_lag6","CPI_lag7",
                                             "CPI_lag8","CPI_lag9",
                                             "CPI_lag10","CPI_lag11","CPI_lag12"),
          report = "vc*", align = TRUE, header = FALSE, df = FALSE, digits = 2, single.row = TRUE,
          model.numbers = FALSE, column.labels = c("CPI","CPI(Stepwise)"), 
          summary = FALSE, 
 out = "F:/R workspace/Modelling-UK-inflation-quarterly-/CPI Summary Table.html",          flip = FALSE, se = NULL, type = "html" )

```
```{r}
stargazer( slr.cpi,
          star.char = c("*"), 
          star.cutoffs = c(0.05, 0.01),
          notes = c(" * p<0.05; ** p<0.01; "),

          dep.var.labels.include = FALSE, 
          notes.append = FALSE,  order = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
          report = "vc*", align = TRUE, header = FALSE, df = FALSE, digits = 2, single.row = TRUE,
          model.numbers = FALSE, column.labels = c("CPI","CPI(Stepwise)"), 
          summary = FALSE, 
          flip = FALSE, se = NULL, type = "text" )
```
s.test



***



# Table 3  Summary table before stepwise (Quarterly data)

**修正summary table 在代码体现最大的变化应该是在run完regression的时候, 再把出去division and groupd的class 汇总在一起 生成新的sig.class, 在对季度数据应用的时候应当也是如此**

```{r}
rm(list = ls())
Sys.setlocale("LC_TIME", "English")
```

```{r}
cpi <- read_excel("correct quarter cpi.xlsx")#108
cols.num <- c(colnames(cpi))#cols.列名
cpi[cols.num] <- sapply(cpi[cols.num],as.numeric)#把所有数据转成数字类型?

cpi <- as.data.table(cpi)
colnames(cpi) = gsub("&", "and", colnames(cpi))#把列名里&换成 and
COPY<-copy(cpi)
tracemem(COPY)==tracemem(cpi)
Data_A = as.data.table (cpi)

Varnames <- copy(names(Data_A))#
Data_A[, (names(Data_A)) := lapply(.SD, as.numeric)][,
                                                     rn := .I]
melted <- melt(Data_A, id.vars="rn")[,
                                     (paste0("lag_", 0:4)) := shift(value, 0:4, type="lag"),
                                     by=variable][, 
                                                  value:=NULL][]
res <- dcast.data.table(melt(melted, id.vars=c("rn", "variable"), variable.name="lag"),
                        rn ~ variable + lag, sum)
res[, ncol(res), with=FALSE]
cpi <- cpi[, unlist(lapply(.SD, shift, n = 0:4), recursive = FALSE)]#lags generation
# quarterly  Dummies ---------------------------------------------------------


cpi$time <- seq.Date(from = as.Date("1992/01/01",format = "%Y/%m/%d"), by = "quarter", length.out = 112)
cpi$time <- format(cpi$time, format = "%b")

cpi <- fastDummies::dummy_cols(cpi, select_columns = "time", remove_most_frequent_dummy = TRUE,
)

cpi$time1 <- seq.Date(from = as.Date("1992/01/01",format = "%Y/%m/%d"), by = "quarter", length.out = 112)
# Trend,vat, recession ----------------------------------------------------

newdata<-copy(cpi)

newdata<-newdata[newdata$'time1' >= as.Date("1993-01-01")]
Trend <- seq_along(newdata$time1)

VAT1 <- as.numeric(newdata$`time1` == "2008-10-01")
VAT2 <- as.numeric(newdata$`time1` == "2010-01-01")
VAT3 <- as.numeric(newdata$`time1` == "2011-01-01")
Recession <- as.numeric(newdata$`time1` >= "2008-04-01" & newdata$`time1`<= "2009-06-01")
# Lag ---------------------------------------------------------------------

lag1 <- newdata %>% 
  select(matches("(2)$"))
lag2 <- newdata %>% 
  select(matches("(3)$"))
lag3 <- newdata %>% 
  select(matches("(4)$"))
lag4 <- newdata %>% 
  select(matches("(5)$"))

# quarterly DUMMIES --------------------------------------------------------


quarter1 <- as.numeric(newdata$time_Jan)
quarter3 <- as.numeric(newdata$time_Jul)
quarter4 <- as.numeric(newdata$time_Oct)

COPY <- as.data.frame(COPY)
lag1 <- as.data.frame(lag1)
lag2 <- as.data.frame(lag2)
lag3 <- as.data.frame(lag3)
lag4 <- as.data.frame(lag4)

# CPI-LAGS ----------------------------------------------------------------


CPI_lag1 <- (newdata$"CPI ALL ITEMS2")
CPI_lag2 <- (newdata$"CPI ALL ITEMS3")
CPI_lag3 <- (newdata$"CPI ALL ITEMS4")
CPI_lag4 <- (newdata$"CPI ALL ITEMS5")

```
```{r}
# Copy删除前四行? --------------------------------------------------

COPY<-COPY[-1:-4,]
```
## Regression
```{r}
regression <- lapply(1:122, function(x) lm(COPY[,x] ~ lag1[,x]+lag2[,x]+lag3[,x]+lag4[,x]+CPI_lag1+CPI_lag2+CPI_lag3+CPI_lag4+ quarter1+quarter3+quarter4+VAT1+VAT2+VAT3+Recession+Trend)
)
for (i in 1:122) {
  names(regression[[i]]$coefficients)<-c('Constant','lag1','lag2',"lag3","lag4",
                                         "CPI_lag1","CPI_lag2","CPI_lag3","CPI_lag4",
                                         "quarter1","quarter3","quarter4",
                                         "VAT1","VAT2","VAT3","Recession","Trend")
}
```

```{r}
regression <- lapply(1:122, function(x) lm(COPY[,x] ~ lag1[,x]+lag2[,x]+lag3[,x]+lag4[,x]+CPI_lag1+CPI_lag2+CPI_lag3+CPI_lag4+ quarter1+quarter3+quarter4+VAT1+VAT2+VAT3+Recession+Trend)
)
for (i in 1:122) {
  names(regression[[i]]$coefficients)<-c('Constant','lag1','lag2',"lag3","lag4",
                                         "CPI_lag1","CPI_lag2","CPI_lag3","CPI_lag4",
                                         "quarter1","quarter3","quarter4",
                                         "VAT1","VAT2","VAT3","Recession","Trend")
}
```

可以重复了
下面是重复yearly 部分
```{r}

percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
# Weight ------------------------------------------------------------------
weight<- list(0.109,	0.042,	0.063,	0.115,	0.067,	0.022,	0.152,	0.023,	0.152,	0.019,	0.137,	0.099
              
)
Reduce("+",weight)
```
用lapply 把regression 这个list 化成长数据框类型.(多行,5列:term,estimate,std,statitc, pvalue)
```{r}

tidy_mods <- lapply(regression, tidy)

for (i in 1:length(tidy_mods)) 
  tidy_mods[[i]]$mod <- names(tidy_mods[i])
a <- do.call(rbind.data.frame, tidy_mods)
str(a)
```

```{r}
dend<-c(2,16,22,28,41,54,62,77,80,102,103,108,122)#这只是每个部门开始的位置
for (i in 1:12) {
  assign(paste0("a",i),
         a[(which(a$term=="Constant")[dend[i]]):(which(a$term=="Trend")[dend[i+1]-1]),])
}
```
### a_lag.0.01
```{r}

a_lag.0.01<-data.frame( row.names =  paste0("lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_lag.0.01)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_lag.0.01 [j,i]  <-
  length( which((get(paste0("a",i)))$term==paste0("lag",j)&(get(paste0("a",i)))$p.value<0.01)
  )*weight[[i]]
  }
  i<-i+1
}
```
### a_lag.0.05
```{r}
a_lag.0.05<-data.frame( row.names =  paste0("lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_lag.0.05)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_lag.0.05 [j,i]  <-
  length( which((get(paste0("a",i)))$term==paste0("lag",j)&(get(paste0("a",i)))$p.value<0.05)
  )*weight[[i]]
  }
  i<-i+1
}
```
### a_cpi.0.01

```{r}
a_cpi.0.01<-data.frame( row.names =  paste0("CPI_lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_cpi.0.01)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_cpi.0.01 [j,i]  <-
  length( which((get(paste0("a",i)))$term==paste0("CPI_lag",j)&(get(paste0("a",i)))$p.value<0.01)
  )*weight[[i]]
  }
  i<-i+1
}
```
### a_cpi.0.05
```{r}
a_cpi.0.05<-data.frame( row.names =  paste0("CPI_lag",1:12),
                   matrix(nrow=12, ncol=12, ) ) 

colnames(a_cpi.0.05)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:12) {
 a_cpi.0.05 [j,i]  <-
  length( which((get(paste0("a",i)))$term==paste0("CPI_lag",j)&(get(paste0("a",i)))$p.value<0.05)
  )*weight[[i]]
  }
  i<-i+1
}
```

# table3写入,这次要生成8*4的dataframe
```{r}
table3Quarterlydata<-data.frame( matrix(nrow=8, ncol=4, )   )
colnames(table3Quarterlydata)<-c("p<0.01","p<0.05","p<0.01(Weight)","p<0.05(Weight)")
rownames(table3Quarterlydata)<-c(paste0("CPI_lag",1:4),paste0("lag",1:4))
```
写入结果
一个没有cpi的a dataframe,删除前41行
```{r}
nocpi<-a[-c(1:41),]
```

```{r}
for (i in 1:4) {#前两列
  table3Quarterlydata[i,1]<-percent((length( which(nocpi$term==paste0("CPI_lag",i)&(nocpi$p.value<0.01))))/121)
   table3Quarterlydata[i+4,1]<-percent((length( which(nocpi$term==paste0("lag",i)&(nocpi$p.value<0.01))))/121)
   table3Quarterlydata[i,2]<-percent((length( which (nocpi$term==paste0("CPI_lag",i)&(nocpi$p.value<0.05))))/121)
      table3Quarterlydata[i+4,2]<-percent((length( which(nocpi$term==paste0("lag",i)&(nocpi$p.value<0.05))))/121)
      #后两列
    table3Quarterlydata[i,3]<-percent(sum(a_cpi.0.01[paste0("CPI_lag",i),])      /121)
    table3Quarterlydata[i+4,3]<-percent(sum(a_lag.0.01[paste0("lag",i),])/121)
    table3Quarterlydata[i,4]<-percent(sum(a_cpi.0.05[paste0("CPI_lag",i),])/121)
    table3Quarterlydata[i+4,4]<-percent(sum(a_lag.0.05[paste0("lag",i),])/121)
    
}



```

flextable 写入word
```{r}

ft1<-flextable(table3Quarterlydata %>% rownames_to_column("column name"))




save_as_docx("Summary table before stepwise (Quarterly data)" = ft1, path = "F:/R workspace/Modelling-UK-inflation-quarterly-/table3.docx")




```


***
# quarterly stepwise

## stepwise function
```{r include=FALSE}
# function ----------------------------------------------------------------


# Automated model selection
# Author      : Joris Meys
# version     : 0.2
# date        : 12/01/09

#CHANGE LOG
# 0.2   : check for empty scopevar vector

# #CHANGE LOG -------------------------------------------------------------



# Function has.interaction checks whether x is part of a term in terms
# terms is a vector with names of terms from a model
has.interaction <- function(x,terms){
  out <- sapply(terms,function(i){
    sum(1-(strsplit(x,":")[[1]] %in% strsplit(i,":")[[1]]))==0
  })
  return(sum(out)>0)
}

# Function Model.select
# model is the lm object of the full model
# keep is a list of model terms to keep in the model at all times
# sig gives the significance for removal of a variable. Can be 0.1 too (see SPSS)
# verbose=T gives the F-tests, dropped var and resulting model after 
model.select <- function(model,keep,sig=0.05,verbose=F){
  counter=1
  # check input
  if(!is(model,"lm")) stop(paste(deparse(substitute(model)),"is not an lm object\n"))
  # calculate scope for drop1 function
  terms <- attr(model$terms,"term.labels")
  if(missing(keep)){ # set scopevars to all terms
    scopevars <- terms
  } else{            # select the scopevars if keep is used
    index <- match(keep,terms)
    # check if all is specified correctly
    if(sum(is.na(index))>0){
      novar <- keep[is.na(index)]
      warning(paste(
        c(novar,"cannot be found in the model",
          "\nThese terms are ignored in the model selection."),
        collapse=" "))
      index <- as.vector(na.omit(index))
    }
    scopevars <- terms[-index]
  }
  
  # Backward model selection : 
  
  while(T){
    # extract the test statistics from drop.
    test <- drop1(model, scope=scopevars,test="F")
    
    if(verbose){
      cat("-------------STEP ",counter,"-------------\n",
          "The drop statistics : \n")
      print(test)
    }
    
    pval <- test[,dim(test)[2]]
    
    names(pval) <- rownames(test)
    pval <- sort(pval,decreasing=T)
    
    if(sum(is.na(pval))>0) stop(paste("Model",
                                      deparse(substitute(model)),"is invalid. Check if all coefficients are estimated."))
    
    # check if all significant
    if(pval[1]<sig) break # stops the loop if all remaining vars are sign.
    
    # select var to drop
    i=1
    while(T){
      dropvar <- names(pval)[i]
      check.terms <- terms[-match(dropvar,terms)]
      x <- has.interaction(dropvar,check.terms)
      if(x){i=i+1;next} else {break}              
    } # end while(T) drop var
    
    if(pval[i]<sig) break # stops the loop if var to remove is significant
    
    if(verbose){
      cat("\n--------\nTerm dropped in step",counter,":",dropvar,"\n--------\n\n")              
    }
    
    #update terms, scopevars and model
    scopevars <- scopevars[-match(dropvar,scopevars)]
    terms <- terms[-match(dropvar,terms)]
    
    formul <- as.formula(paste(".~.-",dropvar))
    model <- update(model,formul)
    
    if(length(scopevars)==0) {
      warning("All variables are thrown out of the model.\n",
              "No model could be specified.")
      return()
    }
    counter=counter+1
  } # end while(T) main loop
  return(model)
}

```




### stepwise process
```{r include=FALSE}
slr.total <- list()
keep.dummies <- c("quarter1","quarter3","quarter4",
                  "VAT1","VAT2","VAT3","Recession","Trend")
for (i in 2:122) {
  slr.total[[i]] <- model.select(regression[[i]], keep = keep.dummies, sig = 0.05, verbose = F)
}



```
## slr.total所有变量都不显著的部门

```{r}
names(slr.total) <- 1:length(slr.total)
class_with_no_significant <- slr.total[which(sapply(slr.total, is.null))]
length(class_with_no_significant)
```



```{r}
#把1和86扔了
slr.total[sapply(slr.total, is.null)] <- NULL

#替换名称
search_for_these <- c("lag1[, x]","lag2[, x]","lag3[, x]","lag4[, x]","lag5[, x]","lag6[, x]","lag7[, x]","lag8[, x]","lag9[, x]","lag10[, x]","lag11[, x]","lag12[, x]")
 replace_with_these <- c("lag1","lag2","lag3","lag4","lag5","lag6","lag7","lag8","lag9","lag10","lag11","lag12")
 found<-list()
for (i in 1:length(slr.total)) {
  found[[i]] <- match(names(slr.total[[i]]$coefficients), search_for_these, nomatch = 0)
  names(slr.total[[i]]$coefficients)[names(slr.total[[i]]$coefficients) %in% search_for_these] <- replace_with_these[found[[i]]]
}
```

```{r}
#化成长数据类型
 tidy_stepwsie <- lapply(slr.total, tidy)
  stepwsie_a<- do.call(rbind.data.frame, tidy_stepwsie)
```

```{r}
length(which(stepwsie_a$term=="VAT1"))
```

## 在没换名字之前slr.total=122个,$`1`$`10`$`35`$`40`$`55`$`57`$`58`$`64`$`69`$`74`$`79`$`86`$`100``103`$`114`$`120`$`121`空集. 替换完名字就变成105了
103部门没有 只能算104的. 104-14
** 新的部门开始的位置等于丢失之前的变量-[n]**
```{r}

dend<-c(2,16,22,28,41,54,62,77,80,102,103,108,122)#这只是每个部门开始的位置
dend_stepwise<-c(2-1,
                 16-2,
                 22-2,
                 28-2,
                 41-4,
                 54-4,
                 62-7,
                 77-10,
                 80-11,
                 102-13,
                 104-14,
                 108-14,
                 122-17
                 )

for (i in 1:12) {
  assign(paste0("stepwsie_a",i),
         stepwsie_a[(which(stepwsie_a$term=="(Intercept)")[dend_stepwise[i]]):(which(stepwsie_a$term=="Trend")[dend_stepwise[i+1]-1]),])
}
```
## 创建	Table 4 Stepwise Summary Table 存储结果 是8*4.
```{r}
stepwise_table_quarterly<-data.frame( matrix(nrow=8, ncol=4, )   )
colnames(stepwise_table_quarterly)<-c("p<0.01","p<0.05","p<0.01(Weight)","p<0.05(Weight)")
rownames(stepwise_table_quarterly)<-c(paste0("CPI_lag",1:4),paste0("lag",1:4))
```

### stepwise_lag_0.01_quarterly
```{r}

stepwise_lag_0.01_quarterly<-data.frame( row.names =  paste0("lag",1:4),
                   matrix(nrow=4, ncol=12, ) ) 

colnames(stepwise_lag_0.01_quarterly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:4) {
 stepwise_lag_0.01_quarterly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.01)
  )*weight[[i]]
  }
  i<-i+1
}
```

### stepwise_lag_0.05_quarterly
```{r}

stepwise_lag_0.05_quarterly<-data.frame( row.names =  paste0("lag",1:4),
                   matrix(nrow=4, ncol=12, ) ) 

colnames(stepwise_lag_0.05_quarterly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:4) {
 stepwise_lag_0.05_quarterly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.05)
  )*weight[[i]]
  }
  i<-i+1
}
```

### stepwise_cpi_0.01_quarterly
```{r}

stepwise_cpi_0.01_quarterly<-data.frame( row.names =  paste0("CPI_lag",1:4),
                   matrix(nrow=4, ncol=12, ) ) 

colnames(stepwise_cpi_0.01_quarterly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:4) {
 stepwise_cpi_0.01_quarterly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("CPI_lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.01)
  )*weight[[i]]
  }
  i<-i+1
}
```

### stepwise_cpi_0.05_quarterly
```{r}

stepwise_cpi_0.05_quarterly<-data.frame( row.names =  paste0("CPI_lag",1:4),
                   matrix(nrow=4, ncol=12, ) ) 

colnames(stepwise_cpi_0.05_quarterly)<-c(paste0("a",1:12))
i<-1#i=a,j=lag
while (i <=12) {
  for (j in 1:4) {
 stepwise_cpi_0.05_quarterly [j,i]  <-
  length( which((get(paste0("stepwsie_a",i)))$term==paste0("CPI_lag",j)&(get(paste0("stepwsie_a",i)))$p.value<0.05)
  )*weight[[i]]
  }
  i<-i+1
}
```

# 写入table4
```{r}
for (i in 1:4) {#前两列
  stepwise_table_quarterly[i,1]<-percent((length( which(stepwsie_a$term==paste0("CPI_lag",i)&(stepwsie_a$p.value<0.01))))/121)
   stepwise_table_quarterly[i+4,1]<-percent((length( which(stepwsie_a$term==paste0("lag",i)&(stepwsie_a$p.value<0.01))))/121)
   stepwise_table_quarterly[i,2]<-percent((length( which(stepwsie_a$term==paste0("CPI_lag",i)&(stepwsie_a$p.value<0.05))))/121)
      stepwise_table_quarterly[i+4,2]<-percent((length( which(stepwsie_a$term==paste0("lag",i)&(stepwsie_a$p.value<0.05))))/121)
      #后两列
    stepwise_table_quarterly[i,3]<-percent(sum(stepwise_cpi_0.01_quarterly[paste0("CPI_lag",i),])      /121)
    stepwise_table_quarterly[i+4,3]<-percent(sum(stepwise_lag_0.01_quarterly[paste0("lag",i),])/121)
    stepwise_table_quarterly[i,4]<-percent(sum(stepwise_cpi_0.05_quarterly[paste0("CPI_lag",i),])/121)
    stepwise_table_quarterly[i+4,4]<-percent(sum(stepwise_lag_0.05_quarterly[paste0("lag",i),])/121)
    
}
```
## flextable 写入word
```{r}



ft1<-flextable(stepwise_table_quarterly %>% rownames_to_column("column name"))




save_as_docx("	Table 4 Stepwise Summary Table (Quarterly data)" = ft1, path = "F:/R workspace/Modelling-UK-inflation-quarterly-/table4.docx")




```


```{r}


stargazer(CPI_, slr.cpi,
          star.char = c("*"), 
          star.cutoffs = c(0.05, 0.01),
          notes = c(" * p<0.05; ** p<0.01; "),
          omit = c("time_Aug","time_Dec", "time_Feb", "time_Jan","time_Jul","time_Jun" ,
                   "time_Mar","time_May","time_Nov","time_Oct","time_Sep", "VAT1","VAT2",
                   "VAT3","Recession","Trend",'Constant'), 
          dep.var.labels.include = FALSE, 
          notes.append = FALSE, # order = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20), 
          report = "vc*", align = TRUE, header = FALSE, df = FALSE, digits = 2, single.row = TRUE,
          model.numbers = FALSE, column.labels = c("CPI","CPI(Stepwise)"), 
          summary = FALSE, out = "C:/Users/PC/Desktop/output/4.15 quarterly data/stepwise-cpi.html", flip = FALSE, se = NULL, type = "html" )

```

